import{_ as o,a as i,b as r,c as p}from"./chunks/sftp.99099f45.js";import{I as a}from"./chunks/iconify.2a90140e.js";import{c,b as e,d as n,u as s,a as t,o as l}from"./app.017cb202.js";var d="/assets/digital-ocean-settings-blazor-litestream.53380889.png",u="/assets/blazor-litestream-deployment-process.fbbd8ddc.png",m="/assets/blazor-litestream-run-workflow.4eeecc81.png";const h={class:"my-8 ml-20 flex flex-col items-center"},k=t('<h2 class="border-none text-4xl sm:text-5xl md:text-6xl tracking-tight font-extrabold"><span class="text-purple-600 mr-6">Blazor</span><span style="color:#44A8B3;">Tailwind</span></h2><p class="mt-3 max-w-md mx-auto text-base text-gray-500 sm:text-lg md:mt-5 md:text-2xl md:max-w-3xl"> Combined with </p><p id="litestream" class="mx-auto max-w-screen-md pr-4 text-center border-none"><a href="https://litestream.io"><img class="h-32" src="'+o+'"></a></p>',3),g=t('<p>As a way to provide a reliable and cost-effective option for building, deploying and hosting Blazor WASM applications with a backing API, we created the mix templates for our Blazor templates to be able to quickly take advantage of <a href="http://Litestream.io" target="_blank" rel="noopener noreferrer">Litestream.io</a>.</p><p>This can be used directly below to create a new Blazor Tailwind project directly with your Litestream replication target of your choice.</p><section class="my-20 text-center"><div class="flex"><div class="flex flex-1 flex-col"><a href="https://account.servicestack.net/archive/NetCoreTemplates/blazor-tailwind?Name=MyApp&amp;Mix=blazor-litestream-aws"><img src="'+i+'" alt="AWS S3" class="w-52"></a><span class="block text-xl font-medium text-gray-900"> Blazor Tailwind with S3 Simple Storage Service </span></div><div class="flex flex-1 flex-col"><a href="https://account.servicestack.net/archive/NetCoreTemplates/blazor-tailwind?Name=MyApp&amp;Mix=blazor-litestream-azure"><img src="'+r+'" alt="Azure Blob Storage" class="w-52"></a><span class="block text-xl font-medium text-gray-900"> Blazor Tailwind with Azure Blob Storage </span></div><div class="flex flex-1 flex-col"><a href="https://account.servicestack.net/archive/NetCoreTemplates/blazor-tailwind?Name=MyApp&amp;Mix=blazor-litestream-sftp"><img src="'+p+'" alt="SFTP" class="w-52"></a></div></div></section><p>Alternatively as the <a href="/github-action-templates">Docker compose</a> configurations are delivered as <a href="/mix-tool">mix</a> configurations, they can also be applied to existing projects, e.g:</p>',4),y=e("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[e("div",{class:"flex-grow bg-gray-800"},[e("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[e("p",null,"x mix blazor-litestream-aws")])]),e("div",{class:"flex"},[e("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[e("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),e("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),w=t('<p>Since Litestream is tied to deployment, hosting environment &amp; preferred configured storage, we&#39;ve had to create a matrix of configurations to integrate with depending on which template you use.</p><table><thead><tr><th>Project Template</th><th>AWS S3</th><th>Azure Blob Storage</th><th>SFTP (generic)</th></tr></thead><tbody><tr><td><strong>web</strong></td><td>litestream-aws</td><td>litestream-azure</td><td>litestream-sftp</td></tr><tr><td><strong>blazor-tailwind</strong></td><td>blazor-litestream-aws</td><td>blazor-litestream-azure</td><td>blazor-litestream-sftp</td></tr><tr><td><strong>blazor-wasm</strong></td><td>blazor-litestream-aws</td><td>blazor-litestream-azure</td><td>blazor-litestream-sftp</td></tr><tr><td><strong>vue-ssg</strong></td><td>jamstack-litestream-aws</td><td>jamstack-litestream-azure</td><td>jamstack-litestream-sftp</td></tr><tr><td><strong>vue-vite</strong></td><td>jamstack-litestream-aws</td><td>jamstack-litestream-azure</td><td>jamstack-litestream-sftp</td></tr><tr><td><strong>nextjs</strong></td><td>jamstack-litestream-aws</td><td>jamstack-litestream-azure</td><td>jamstack-litestream-sftp</td></tr></tbody></table><h3 id="github-action-workflow" tabindex="-1">GitHub Action Workflow <a class="header-anchor" href="#github-action-workflow" aria-hidden="true">#</a></h3><p>These GitHub Action configurations are a quicker way to create and deploy new Applications, which only need to be filled in with your environment&#39;s access credentials configured in your <a href="/litestream-templates.html#github-action-workflow">projects GitHub Action Secrets</a>.</p><h2 id="setting-up-your-linux-host" tabindex="-1">Setting up your Linux host <a class="header-anchor" href="#setting-up-your-linux-host" aria-hidden="true">#</a></h2><p>This project template is set up to deploy to any Linux with SSH access, and Docker with Docker Compose installed. This means you can choose any hosting provider or own server to make your application extremely portable.</p><p>For example, we can use DigitalOcean droplets at $48 USD per month to host our application with good performance, especially for heavy read scenarios.</p><p>Using the DigitalOcean console, we can select <code>Create</code> droplet at the top and select the following options.</p><ul><li>Ubuntu 20.04 LTS x64 image</li><li>Basic Plan type</li><li>CPU options of Regular with SSD</li><li>$48 per month droplet</li><li>Your preferred region</li><li>SSH keys for Authentication</li></ul><p><img src="'+d+`" alt=""></p><p>Once our droplet is started, we will want to use a Reserved IP address and copy the value. This IP should be used with your DNS configuration for your domain as an A record. How this is done will depend on what service you use to manage your domains, eg AWS Route53, GoDaddy etc.</p><h2 id="docker-and-docker-compose-installation" tabindex="-1">Docker and Docker-Compose Installation <a class="header-anchor" href="#docker-and-docker-compose-installation" aria-hidden="true">#</a></h2><p>Below are two guides for installing Docker and Docker-Compose for Ubuntu 20.04 LTS.</p><ul><li><a href="https://docs.docker.com/engine/install/ubuntu" target="_blank" rel="noopener noreferrer">Docker Installation Guide</a></li><li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-compose-on-ubuntu-20-04" target="_blank" rel="noopener noreferrer">Docker-Compose Installation Guide</a></li></ul><h2 id="nginx-reverse-proxy" tabindex="-1">nginx reverse proxy <a class="header-anchor" href="#nginx-reverse-proxy" aria-hidden="true">#</a></h2><p>Now that we have our host created with Docker and Docker-Compose installed, we need to do some one-off configuration to make it easy to host and deploy our application to it using GitHub Actions and docker-compose.</p><p>As a part of the <code>blazor-tailwind</code> project template, you will have a file called <code>nginx-proxy-compose.yml</code> in the <code>.deploy</code> directory. This contains a docker-compose configuration to run an NGINX reverse proxy and a companion container to automatically manage TLS certificates via LetsEncrypt.</p><div class="language-yaml"><pre><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">&#39;2&#39;</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nginx-proxy</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> jwilder/nginx<span class="token punctuation">-</span>proxy
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;80:80&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;443:443&quot;</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> conf<span class="token punctuation">:</span>/etc/nginx/conf.d
      <span class="token punctuation">-</span> vhost<span class="token punctuation">:</span>/etc/nginx/vhost.d
      <span class="token punctuation">-</span> html<span class="token punctuation">:</span>/usr/share/nginx/html
      <span class="token punctuation">-</span> dhparam<span class="token punctuation">:</span>/etc/nginx/dhparam
      <span class="token punctuation">-</span> certs<span class="token punctuation">:</span>/etc/nginx/certs<span class="token punctuation">:</span>ro
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/tmp/docker.sock<span class="token punctuation">:</span>ro
    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> bridge

  <span class="token key atrule">letsencrypt</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> jrcs/letsencrypt<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>companion<span class="token punctuation">:</span><span class="token number">2.0</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>le
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> DEFAULT_EMAIL=you@example.com
    <span class="token key atrule">volumes_from</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nginx<span class="token punctuation">-</span>proxy
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> certs<span class="token punctuation">:</span>/etc/nginx/certs<span class="token punctuation">:</span>rw
      <span class="token punctuation">-</span> acme<span class="token punctuation">:</span>/etc/acme.sh
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock<span class="token punctuation">:</span>ro
    <span class="token key atrule">network_mode</span><span class="token punctuation">:</span> bridge

<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">conf</span><span class="token punctuation">:</span>
  <span class="token key atrule">vhost</span><span class="token punctuation">:</span>
  <span class="token key atrule">html</span><span class="token punctuation">:</span>
  <span class="token key atrule">dhparam</span><span class="token punctuation">:</span>
  <span class="token key atrule">certs</span><span class="token punctuation">:</span>
  <span class="token key atrule">acme</span><span class="token punctuation">:</span>

</code></pre></div><p>Copy the file to your Linux host using <code>scp</code> or pasting in the above into a <code>vi</code> editor and save so we can update the file and run it remotely.</p><p>Update the <code>DEFAULT_EMAIL</code> environment variable to make sure you will get notified about problems with your TLS certificates and use the following command on your Linux host to run these containers.</p>`,20),f=e("div",{class:"sh-copy cp flex cursor-pointer mb-3",onclick:"copy(this)"},[e("div",{class:"flex-grow bg-gray-800"},[e("div",{class:"pl-4 py-1 pb-1.5 align-middle whitespace-pre text-base text-gray-100"},[e("p",null,"docker-compose -f nginx-proxy-compose.yml up -d")])]),e("div",{class:"flex"},[e("div",{class:"bg-green-600 text-white p-1.5 pb-0"},[e("svg",{class:"copied w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})]),e("svg",{class:"nocopy w-6 h-6",title:"copy",fill:"none",stroke:"white",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"1",d:"M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"})])])])],-1),b=t(`<p>Once running, you should see a message similar to the following.</p><div class="language-shell"><pre><code>Creating nginx-proxy <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Creating nginx-proxy-le <span class="token punctuation">..</span>. <span class="token keyword">done</span>
</code></pre></div><p>Your Linux host is now ready to deploy to using GitHub Actions.</p><h2 id="github-actions" tabindex="-1">GitHub Actions <a class="header-anchor" href="#github-actions" aria-hidden="true">#</a></h2><p>The Blazor-Tailwind project templates and Litestream mix templates have a <code>release.yml</code> GitHub Action workflow to deploying your application to a Linux host like the one we just set up. This workflow uses SSH access to remotely copy files and execute <code>docker-compose</code> commands on the remote host.</p><p>Docker images are stored on GitHub Container Repository packages, and pulled down on the remote host during deployment.</p><p><img src="`+u+'" alt=""></p><p>To get this working, repository secrets in your GitHub repository need to be populated</p><table><thead><tr><th>Secret</th><th>Description</th><th>Example</th></tr></thead><tbody><tr><td>DEPLOY_API</td><td>Resolvable DNS address to your Linux host</td><td><a href="http://my-app.example.com" target="_blank" rel="noopener noreferrer">my-app.example.com</a></td></tr><tr><td>DEPLOY_USERNAME</td><td>The SSH login username</td><td>ubuntu</td></tr><tr><td>DEPLOY_KEY</td><td>The SSH <em>private</em> key associated with the SSH login</td><td></td></tr><tr><td>LETSENCRYPT_EMAIL</td><td>Email address where you want notifications to go specifically related to this application domain</td><td><a href="mailto:me@email.com">me@email.com</a></td></tr><tr><td>AWS_S3_BUCKET</td><td>An S3 bucket name where Litestream will be replicating data</td><td>my-s3-bucket-name</td></tr><tr><td>AWS_ACCESS_KEY_ID</td><td>The key ID for programmatic access to AWS with read/write access to the S3 bucket</td><td></td></tr><tr><td>AWS_SECRET_ACCESS_KEY</td><td>The access key for programmatic access to AWS with read/write access to the S3 bucket</td><td></td></tr></tbody></table><p>These repository secrets can be added by using the GitHub repository under <code>Settings</code>, <code>Secrets</code>, <code>Actions</code>.</p><p>Once values are assigned, you can use the <code>Actions</code> tab on your repository to create a new <code>Release</code> workflow using the <code>Run workflow</code> dropdown.</p><p><img src="'+m+`" alt=""></p><p>Once deployed, the Litestream docker sidecar container will monitor changes to your <code>app.db</code> SQLite database and back them up to your configured AWS S3 bucket.</p><h2 id="litestream-automation" tabindex="-1">Litestream automation <a class="header-anchor" href="#litestream-automation" aria-hidden="true">#</a></h2><p>The <code>docker-compose-template.yml</code> file in the template is used to create the final running docker-compose configuration of your application and related Litestream sidecar. The Litestream sidecar runs as a separate container with access to the same docker volume as your application to replicate data from your SQLite database file.</p><p>This monitoring starts before your application docker container runs so that data isn&#39;t missed. This is achieved using the docker-compose functionality of <code>depends_on</code> and <code>test</code>, where your Blazor WASM application container will wait for the successful startup of the Litestream container before running.</p><div class="language-yaml"><pre><code><span class="token key atrule">my-app</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/$<span class="token punctuation">{</span>IMAGE_REPO<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>RELEASE_VERSION<span class="token punctuation">}</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token key atrule">my-app-litestream</span><span class="token punctuation">:</span>
        <span class="token key atrule">condition</span><span class="token punctuation">:</span> service_healthy
</code></pre></div><p>The <code>healthcheck</code> for your Blazor WASM container is that a Litestream <code>restore</code> process runs successfully on deployment. This is the functionality that provides automated disaster recovery if your SQLite database file is lost for whatever reason.</p><div class="language-yaml"><pre><code><span class="token key atrule">my-app-litestream</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> litestream/litestream
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">]</span>
    <span class="token comment"># Timeout of health check will need to depend on size of db, and speed of network to host.</span>
    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>
      <span class="token key atrule">test</span><span class="token punctuation">:</span> /usr/local/bin/litestream restore <span class="token punctuation">-</span>if<span class="token punctuation">-</span>db<span class="token punctuation">-</span>not<span class="token punctuation">-</span>exists <span class="token punctuation">-</span>if<span class="token punctuation">-</span>replica<span class="token punctuation">-</span>exists <span class="token punctuation">-</span>o /data/app.db s3<span class="token punctuation">:</span>//$<span class="token punctuation">{</span>AWS_S3_BUCKET<span class="token punctuation">}</span>/BlazorLitestream.sqlite
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10m
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Timeout of health check will need to depend on size of db, and speed of network to host.</p></div><p>This restore will be skipped if either the database file already exists on the server or doesn&#39;t yet exist in AWS S3.</p><h2 id="testing-restores" tabindex="-1">Testing restores <a class="header-anchor" href="#testing-restores" aria-hidden="true">#</a></h2><p>It is always a good idea to test your disaster recovery process, and the easiest way to test it with this Litestream setup is by doing the following steps.</p><ul><li>Take down your application using <code>docker-compose</code> <code>down</code> command pointing to the file on your remote server in the <code>.deploy</code> direct of your deploy user.</li><li>Removing the docker volume using <code>docker volume rm &lt;volume_name&gt;</code>. You can find the volume name using <code>docker volume ls</code>, it will start with <code>deploy_</code> and contain your app name.</li><li>Verifying your SQLite database file no longer exists by checking <code>/var/lib/docker/volumes</code> for the existence of your shared volume files.</li></ul><p>Once confirmed the files are removed, you can then redeploy your application. This process will take longer than a normal deployment since Litestream will be combining the last snapshot with the WAL journal files.</p><p>Once completed, your application should be running with all the previous data it had before being taken down.</p>`,26),z='{"title":"GitHub Action Workflow","description":"","frontmatter":{"slug":"blazor-litestream"},"headers":[{"level":3,"title":"GitHub Action Workflow","slug":"github-action-workflow"},{"level":2,"title":"Setting up your Linux host","slug":"setting-up-your-linux-host"},{"level":2,"title":"Docker and Docker-Compose Installation","slug":"docker-and-docker-compose-installation"},{"level":2,"title":"nginx reverse proxy","slug":"nginx-reverse-proxy"},{"level":2,"title":"GitHub Actions","slug":"github-actions"},{"level":2,"title":"Litestream automation","slug":"litestream-automation"},{"level":2,"title":"Testing restores","slug":"testing-restores"}],"relativePath":"blazor-litestream.md"}',x={},E=Object.assign(x,{setup(v){return(_,S)=>(l(),c("div",null,[e("div",h,[e("div",null,[n(s(a),{icon:"simple-icons:blazor",class:"w-40 h-40 text-purple-600 mr-8"}),n(s(a),{icon:"logos:tailwindcss-icon",class:"w-44 h-44"})]),k]),g,y,w,f,b]))}});export{z as __pageData,E as default};
